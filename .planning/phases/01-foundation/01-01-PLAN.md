---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/inngest/client.ts
  - app/inngest/functions/index.ts
  - app/inngest/types.ts
  - app/routes/api.inngest.ts
  - app/lib/retry.server.ts
  - package.json
autonomous: true
user_setup:
  - service: inngest
    why: "Background job processing and observability"
    env_vars:
      - name: INNGEST_SIGNING_KEY
        source: "Inngest Dashboard -> Manage -> Signing Key (after npx inngest-cli dev registration)"
      - name: INNGEST_EVENT_KEY
        source: "Inngest Dashboard -> Manage -> Event Key"

must_haves:
  truths:
    - "Inngest client is initialized with typed events"
    - "Inngest serve route responds to Inngest cloud"
    - "Exponential backoff utility handles retries with jitter"
  artifacts:
    - path: "app/inngest/client.ts"
      provides: "Typed Inngest client"
      exports: ["inngest"]
    - path: "app/inngest/functions/index.ts"
      provides: "Function registry"
      exports: ["functions"]
    - path: "app/routes/api.inngest.ts"
      provides: "Inngest serve handler"
      exports: ["action", "loader"]
    - path: "app/lib/retry.server.ts"
      provides: "Exponential backoff utility"
      exports: ["callWithRetry"]
  key_links:
    - from: "app/routes/api.inngest.ts"
      to: "app/inngest/client.ts"
      via: "imports inngest client"
      pattern: "import.*inngest.*from.*~/inngest/client"
    - from: "app/routes/api.inngest.ts"
      to: "app/inngest/functions/index.ts"
      via: "imports functions registry"
      pattern: "import.*functions.*from.*~/inngest/functions"
---

<objective>
Set up Inngest background job infrastructure with typed events and exponential backoff utility.

Purpose: Inngest provides durable execution for background jobs (webhook processing, token refresh, scraping) with zero infrastructure overhead. This is the foundation for all async work in the app.

Output: Working Inngest setup that can receive events and process functions, plus retry utility for external API calls.
</objective>

<execution_context>
@/Users/mostefaouim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mostefaouim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Existing files to understand patterns
@app/lib/db.server.ts
@app/routes/api.webhooks.salla.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Inngest client with typed events</name>
  <files>
    package.json
    app/inngest/client.ts
    app/inngest/types.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install inngest exponential-backoff
   ```

2. Create `app/inngest/types.ts` - Event type definitions:
   ```typescript
   // Type definitions for all Inngest events
   export type Events = {
     "app/webhook.received": {
       data: {
         event: string;
         merchantSallaId: number;
         payload: unknown;
         webhookHistoryId: string;
       };
     };
     "app/token.refresh-needed": {
       data: {
         merchantId: string;
       };
     };
     // Future events for scraping, AI processing
     "product/scrape.requested": {
       data: {
         productId: string;
         sourceUrl: string;
         merchantId: string;
       };
     };
   };
   ```

3. Create `app/inngest/client.ts`:
   ```typescript
   import { Inngest, EventSchemas } from "inngest";
   import type { Events } from "./types";

   export const inngest = new Inngest({
     id: "salla-da9i9a",
     schemas: new EventSchemas().fromRecord<Events>(),
   });
   ```
  </action>
  <verify>
    - `npm ls inngest` shows inngest installed
    - `npm ls exponential-backoff` shows exponential-backoff installed
    - Files exist: `app/inngest/client.ts`, `app/inngest/types.ts`
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
    Inngest client created with typed event definitions for webhook processing, token refresh, and product scraping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Inngest serve route and function registry</name>
  <files>
    app/inngest/functions/index.ts
    app/routes/api.inngest.ts
  </files>
  <action>
1. Create `app/inngest/functions/index.ts` - Empty function registry (functions added in later plans):
   ```typescript
   // Export all Inngest functions
   // Functions will be added by later plans (webhook processing, token refresh, etc.)
   export const functions = [];
   ```

2. Create `app/routes/api.inngest.ts` - Serve handler for React Router 7:
   ```typescript
   /**
    * Inngest Serve Handler
    *
    * This route serves Inngest functions and handles event processing.
    * Both GET (registration/introspection) and POST (event handling) are needed.
    *
    * Route: /api/inngest
    *
    * @see https://www.inngest.com/docs/learn/serving-inngest-functions
    */
   import { serve } from "inngest/remix";
   import { inngest } from "~/inngest/client";
   import { functions } from "~/inngest/functions";

   const handler = serve({
     client: inngest,
     functions,
   });

   // React Router 7 uses loader for GET, action for POST
   export { handler as action, handler as loader };
   ```
  </action>
  <verify>
    - Files exist: `app/inngest/functions/index.ts`, `app/routes/api.inngest.ts`
    - TypeScript compiles: `npx tsc --noEmit`
    - Dev server starts without error: `npm run dev` (check console for no import errors)
  </verify>
  <done>
    Inngest serve route operational at /api/inngest with empty function registry ready for functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create exponential backoff retry utility</name>
  <files>
    app/lib/retry.server.ts
  </files>
  <action>
1. Create `app/lib/retry.server.ts`:
   ```typescript
   /**
    * Exponential Backoff Retry Utility
    *
    * Provides retry logic with jitter for external API calls (Salla, scrapers, etc.)
    * Prevents thundering herd problem with full jitter.
    *
    * @see https://www.npmjs.com/package/exponential-backoff
    */
   import { backOff, type BackoffOptions } from "exponential-backoff";

   /**
    * Retry configuration presets for different use cases
    */
   export const RetryPresets = {
     // For Salla API calls - moderate retry with rate limit awareness
     sallaApi: {
       numOfAttempts: 5,
       startingDelay: 1000,
       timeMultiple: 2,
       maxDelay: 30000,
       jitter: "full" as const,
     },
     // For scrapers - longer delays, more attempts
     scraper: {
       numOfAttempts: 3,
       startingDelay: 5000,
       timeMultiple: 2,
       maxDelay: 60000,
       jitter: "full" as const,
     },
     // For AI APIs - quick retry for transient failures
     aiApi: {
       numOfAttempts: 3,
       startingDelay: 500,
       timeMultiple: 2,
       maxDelay: 10000,
       jitter: "full" as const,
     },
   };

   /**
    * Error codes that indicate transient failures worth retrying
    */
   function isRetryableError(error: unknown): boolean {
     if (!(error instanceof Error)) return false;

     const message = error.message || "";
     return (
       message.includes("429") || // Rate limited
       message.includes("500") || // Server error
       message.includes("502") || // Bad gateway
       message.includes("503") || // Service unavailable
       message.includes("504") || // Gateway timeout
       message.includes("ECONNRESET") ||
       message.includes("ETIMEDOUT") ||
       message.includes("ECONNREFUSED")
     );
   }

   /**
    * Call an async function with exponential backoff retry
    *
    * @param fn - The async function to call
    * @param options - Backoff options (use RetryPresets or custom)
    * @returns The result of the function
    * @throws The last error if all retries fail
    *
    * @example
    * const result = await callWithRetry(
    *   () => sallaClient.getProducts(),
    *   RetryPresets.sallaApi
    * );
    */
   export async function callWithRetry<T>(
     fn: () => Promise<T>,
     options: Partial<BackoffOptions> = RetryPresets.sallaApi
   ): Promise<T> {
     return backOff(fn, {
       ...options,
       retry: (error: Error, attemptNumber: number) => {
         const shouldRetry = isRetryableError(error);
         if (shouldRetry) {
           console.log(`[Retry] Attempt ${attemptNumber} failed, retrying:`, error.message);
         }
         return shouldRetry;
       },
     });
   }
   ```
  </action>
  <verify>
    - File exists: `app/lib/retry.server.ts`
    - TypeScript compiles: `npx tsc --noEmit`
    - Exports are correct: grep for "export" in the file shows `RetryPresets`, `callWithRetry`
  </verify>
  <done>
    Exponential backoff utility with presets for Salla API, scrapers, and AI APIs ready for use.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Package check:**
   ```bash
   npm ls inngest exponential-backoff
   ```
   Both packages should be installed.

2. **File structure check:**
   ```bash
   ls -la app/inngest/
   ls -la app/routes/api.inngest.ts
   ls -la app/lib/retry.server.ts
   ```
   All files should exist.

3. **TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   ```
   No errors.

4. **Dev server smoke test:**
   ```bash
   npm run dev &
   sleep 5
   curl http://localhost:5173/api/inngest
   ```
   Should return Inngest introspection response (not 404).
</verification>

<success_criteria>
- Inngest client initialized with typed events for webhook, token refresh, and product scraping
- Serve route at /api/inngest responds to Inngest cloud
- Exponential backoff utility exported with presets for different API types
- All TypeScript compiles without errors
- Dev server starts without import errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
