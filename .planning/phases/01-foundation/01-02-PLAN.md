---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/lib/sentry.client.ts
  - app/lib/sentry.server.ts
  - app/entry.client.tsx
  - app/root.tsx
  - package.json
autonomous: true
user_setup:
  - service: sentry
    why: "Error tracking and monitoring"
    env_vars:
      - name: VITE_SENTRY_DSN
        source: "Sentry Dashboard -> Project Settings -> Client Keys (DSN)"
      - name: SENTRY_DSN
        source: "Same DSN as above (for server-side)"
    dashboard_config:
      - task: "Create new project"
        location: "Sentry Dashboard -> Projects -> Create Project -> Choose React"

must_haves:
  truths:
    - "Client-side errors are captured and sent to Sentry"
    - "Server-side errors are captured and sent to Sentry"
    - "React 19 error handlers are integrated"
  artifacts:
    - path: "app/lib/sentry.client.ts"
      provides: "Browser Sentry initialization"
      exports: ["initSentry"]
    - path: "app/lib/sentry.server.ts"
      provides: "Server Sentry initialization"
      exports: ["initSentry", "captureException"]
    - path: "app/entry.client.tsx"
      provides: "Client entry with Sentry init"
      min_lines: 20
    - path: "app/root.tsx"
      provides: "Root with ErrorBoundary"
      contains: "ErrorBoundary"
  key_links:
    - from: "app/entry.client.tsx"
      to: "app/lib/sentry.client.ts"
      via: "imports and calls initSentry"
      pattern: "initSentry\\(\\)"
    - from: "app/root.tsx"
      to: "@sentry/react"
      via: "ErrorBoundary component"
      pattern: "Sentry\\.ErrorBoundary"
---

<objective>
Set up Sentry error tracking for both client and server-side error capture.

Purpose: Production apps need visibility into errors. Sentry provides stack traces, user context, and alerting. React 19 has new error hooks that Sentry 10.33+ supports natively.

Output: Working Sentry integration that captures errors in browser and server, with React 19 error boundaries.
</objective>

<execution_context>
@/Users/mostefaouim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mostefaouim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Existing files to understand patterns
@app/root.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sentry and create initialization modules</name>
  <files>
    package.json
    app/lib/sentry.client.ts
    app/lib/sentry.server.ts
  </files>
  <action>
1. Install Sentry:
   ```bash
   npm install @sentry/react @sentry/node
   ```

2. Create `app/lib/sentry.client.ts` - Browser initialization:
   ```typescript
   /**
    * Sentry Browser Initialization
    *
    * Configures Sentry for client-side error tracking with:
    * - Browser tracing for performance
    * - Session replay for debugging
    * - React 19 native error hooks
    *
    * @see https://docs.sentry.io/platforms/javascript/guides/react/
    */
   import * as Sentry from "@sentry/react";

   let initialized = false;

   export function initSentry() {
     if (initialized) return;

     const dsn = import.meta.env.VITE_SENTRY_DSN;

     // Skip if no DSN configured (local development)
     if (!dsn) {
       console.log("[Sentry] No DSN configured, skipping initialization");
       return;
     }

     Sentry.init({
       dsn,
       environment: import.meta.env.MODE,
       enabled: import.meta.env.PROD,
       integrations: [
         Sentry.browserTracingIntegration(),
         Sentry.replayIntegration({
           maskAllText: false,
           blockAllMedia: false,
         }),
       ],
       // Performance monitoring
       tracesSampleRate: 0.1, // 10% of transactions in production
       // Session replay
       replaysSessionSampleRate: 0.1, // 10% of sessions
       replaysOnErrorSampleRate: 1.0, // 100% of sessions with errors
     });

     initialized = true;
     console.log("[Sentry] Client initialized");
   }

   // Re-export Sentry for ErrorBoundary usage
   export { Sentry };
   ```

3. Create `app/lib/sentry.server.ts` - Server initialization:
   ```typescript
   /**
    * Sentry Server Initialization
    *
    * Configures Sentry for server-side error tracking.
    *
    * @see https://docs.sentry.io/platforms/javascript/guides/node/
    */
   import * as Sentry from "@sentry/node";

   let initialized = false;

   export function initSentry() {
     if (initialized) return;

     const dsn = process.env.SENTRY_DSN;

     // Skip if no DSN configured
     if (!dsn) {
       console.log("[Sentry] No DSN configured, skipping server initialization");
       return;
     }

     Sentry.init({
       dsn,
       environment: process.env.NODE_ENV,
       enabled: process.env.NODE_ENV === "production",
       tracesSampleRate: 0.1,
     });

     initialized = true;
     console.log("[Sentry] Server initialized");
   }

   /**
    * Capture an exception with optional context
    */
   export function captureException(error: unknown, context?: Record<string, unknown>) {
     if (context) {
       Sentry.setContext("additional", context);
     }
     Sentry.captureException(error);
   }

   /**
    * Set user context for error reports
    */
   export function setUser(user: { id: string; email?: string }) {
     Sentry.setUser(user);
   }

   // Re-export for direct usage
   export { Sentry };
   ```
  </action>
  <verify>
    - `npm ls @sentry/react @sentry/node` shows both packages installed
    - Files exist: `app/lib/sentry.client.ts`, `app/lib/sentry.server.ts`
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
    Sentry initialization modules created for both client and server with appropriate configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client entry point with Sentry and React 19 error hooks</name>
  <files>
    app/entry.client.tsx
  </files>
  <action>
1. Create `app/entry.client.tsx` - Client entry with Sentry and React 19 error hooks:
   ```typescript
   /**
    * Client Entry Point
    *
    * Initializes Sentry before hydrating the React app.
    * Uses React 19 native error hooks for better error capture.
    */
   import { startTransition, StrictMode } from "react";
   import { hydrateRoot } from "react-dom/client";
   import { HydratedRouter } from "react-router/dom";
   import { initSentry, Sentry } from "~/lib/sentry.client";

   // Initialize Sentry before anything else
   initSentry();

   startTransition(() => {
     hydrateRoot(
       document,
       <StrictMode>
         <HydratedRouter />
       </StrictMode>,
       {
         // React 19 error hooks - Sentry captures all error types
         onUncaughtError: Sentry.reactErrorHandler(),
         onCaughtError: Sentry.reactErrorHandler(),
         onRecoverableError: Sentry.reactErrorHandler(),
       }
     );
   });
   ```
  </action>
  <verify>
    - File exists: `app/entry.client.tsx`
    - TypeScript compiles: `npx tsc --noEmit`
    - File contains React 19 error hooks: `grep -E "onUncaughtError|onCaughtError|onRecoverableError" app/entry.client.tsx`
  </verify>
  <done>
    Client entry point created with Sentry initialization and React 19 native error hooks.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wrap app root with Sentry ErrorBoundary</name>
  <files>
    app/root.tsx
  </files>
  <action>
1. Read the existing `app/root.tsx` file first.

2. Modify `app/root.tsx` to add Sentry ErrorBoundary:
   - Add import: `import { Sentry } from "~/lib/sentry.client";`
   - Create a simple fallback error component
   - Wrap the main `<Outlet />` with `<Sentry.ErrorBoundary>`

   The key changes (integrate with existing file structure):

   ```typescript
   // Add this import near the top
   import { Sentry } from "~/lib/sentry.client";

   // Add this error fallback component before the Layout function
   function ErrorFallback({ error }: { error: Error }) {
     return (
       <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-950">
         <div className="max-w-md mx-auto text-center p-8">
           <div className="text-red-500 text-5xl mb-4">!</div>
           <h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-2">
             Something went wrong
           </h1>
           <p className="text-gray-600 dark:text-gray-400 mb-6">
             We've been notified and are looking into it.
           </p>
           <button
             onClick={() => window.location.reload()}
             className="inline-flex items-center justify-center px-6 py-3 text-lg font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors"
           >
             Reload Page
           </button>
         </div>
       </div>
     );
   }

   // In the Layout component, wrap Outlet with ErrorBoundary:
   // Change from: <Outlet />
   // To:
   <Sentry.ErrorBoundary fallback={({ error }) => <ErrorFallback error={error as Error} />}>
     <Outlet />
   </Sentry.ErrorBoundary>
   ```

   IMPORTANT: Preserve all existing imports, meta, links, and Layout structure. Only add the ErrorBoundary wrapper around Outlet.
  </action>
  <verify>
    - `grep "Sentry.ErrorBoundary" app/root.tsx` returns match
    - `grep "ErrorFallback" app/root.tsx` returns match
    - TypeScript compiles: `npx tsc --noEmit`
    - Dev server starts: `npm run dev` (no import errors)
  </verify>
  <done>
    App root wrapped with Sentry ErrorBoundary that captures errors and shows user-friendly fallback.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Package check:**
   ```bash
   npm ls @sentry/react @sentry/node
   ```
   Both packages should be installed.

2. **File structure check:**
   ```bash
   ls -la app/lib/sentry.*.ts
   ls -la app/entry.client.tsx
   ```
   All files should exist.

3. **TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   ```
   No errors.

4. **Build check:**
   ```bash
   npm run build
   ```
   Build should complete successfully.

5. **Sentry integration check:**
   ```bash
   grep -r "Sentry" app/
   ```
   Should show imports in entry.client.tsx, root.tsx, sentry.client.ts, sentry.server.ts
</verification>

<success_criteria>
- Sentry client library initialized in browser with tracing and replay
- Sentry node library initialized on server
- React 19 error hooks connected to Sentry
- ErrorBoundary wraps app with user-friendly fallback
- All TypeScript compiles without errors
- App builds and runs with Sentry (gracefully handles missing DSN in dev)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
