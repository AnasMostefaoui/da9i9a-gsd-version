---
phase: 02-product-scraping
verified: 2026-01-31T22:15:00Z
status: gaps_found
score: 10/11 must-haves verified
gaps:
  - truth: "Cost stored in product metadata for later aggregation"
    status: failed
    reason: "Orchestrator generates costMetadata but Inngest function doesn't store it"
    artifacts:
      - path: "app/inngest/functions/scrape-product.ts"
        issue: "Lines 85-94 store metadata but exclude scraped.costMetadata field"
    missing:
      - "Add scraped.costMetadata to product.metadata in scrape-product.ts update step"
      - "Ensure scrapeCost object is persisted: { provider, platform, estimatedCostUsd, scrapedAt, duration }"
---

# Phase 2: Product Scraping Verification Report

**Phase Goal:** Reliable product data extraction with async processing and fallback strategies

**Verified:** 2026-01-31T22:15:00Z

**Status:** gaps_found

**Re-verification:** No — initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | User submits URL and sees immediate feedback (job queued) | ✓ VERIFIED | import.tsx creates product with IMPORTING status, redirects to /import/status/:jobId |
| 2 | Scraping runs in background without blocking UI | ✓ VERIFIED | inngest.send() dispatches job, returns immediately (lines 89-96) |
| 3 | User can poll job status and see progress | ✓ VERIFIED | api.scrape-status.$jobId.ts returns status, import.status.$jobId.tsx polls every 2s |
| 4 | Completed job redirects to product page | ✓ VERIFIED | Status page checks for IMPORTED/ENHANCED and redirects (line 83-85) |
| 5 | Failed jobs show error and allow retry | ✓ VERIFIED | Status page shows error UI with retry button (lines 141-178) |
| 6 | Products with images but no text still get title and description | ✓ VERIFIED | orchestrator.server.ts calls analyzeProductImage when title missing (lines 159-180) |
| 7 | AI fallback only triggers when text scraping fails | ✓ VERIFIED | validateProduct() checks needsVisionFallback, only triggers when title missing + images exist (lines 158-181) |
| 8 | Generated content clearly marked as AI-generated in metadata | ✓ VERIFIED | orchestrator sets product.aiGenerated = true and provider includes "+vision" suffix (lines 167-168) |
| 9 | Every scrape records provider name and estimated cost | ✓ VERIFIED | orchestrator.server.ts calls createCostMetadata and attaches to product.costMetadata (lines 184-193) |
| 10 | Cost stored in product metadata for later aggregation | ✗ FAILED | costMetadata generated by orchestrator but NOT saved to database by Inngest function |
| 11 | Merchant usage can be summed for subscription enforcement | ✓ VERIFIED | sumScrapeCosts() utility exists in cost-tracker.server.ts (lines 99-101), can aggregate when storage fixed |

**Score:** 10/11 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `app/inngest/functions/scrape-product.ts` | Async scraping job handler | ✓ VERIFIED | 162 lines, substantive, exports scrapeProduct, registered in functions/index.ts |
| `app/routes/api.scrape-status.$jobId.ts` | Job status polling endpoint | ✓ VERIFIED | 71 lines, substantive, exports loader, handles auth and status checks |
| `app/services/ai/vision.server.ts` | Gemini Vision image analysis | ✓ VERIFIED | 256 lines, substantive, exports analyzeProductImage and isVisionConfigured |
| `app/services/scraping/orchestrator.server.ts` | Updated orchestrator with AI fallback | ✓ VERIFIED | 327 lines, imports and calls analyzeProductImage (line 163), cost tracking integrated |
| `app/services/scraping/cost-tracker.server.ts` | Cost estimation utilities | ✓ VERIFIED | 123 lines, substantive, exports estimateScrapeCost, PROVIDER_COSTS, createCostMetadata |
| `prisma/schema.prisma` | Metadata documentation | ✓ VERIFIED | Lines 71-93 document metadata structure including scrapeCost schema |

### Key Link Verification

| From | To | Via | Status | Details |
|------|-----|-----|--------|---------|
| import.tsx | inngest.send | Event dispatch | ✓ WIRED | Lines 89-96 send "product/scrape.requested" with productId, sourceUrl, merchantId |
| scrape-product.ts | orchestrator.scrapeProduct | Function invocation | ✓ WIRED | Line 66 calls orchestrator.scrapeProduct(sourceUrl, false) |
| orchestrator.server.ts | vision.server.ts | AI fallback | ✓ WIRED | Line 163 calls analyzeProductImage when validation indicates needsVisionFallback |
| orchestrator.server.ts | cost-tracker.server.ts | Cost calculation | ✓ WIRED | Line 184 calls createCostMetadata, line 189 attaches to product.costMetadata |
| scrape-product.ts | database | Cost metadata storage | ✗ NOT_WIRED | metadata object (lines 85-94) excludes scraped.costMetadata field |

### Requirements Coverage

| Requirement | Status | Blocking Issue |
|-------------|--------|----------------|
| SCRAPE-01: Extract AliExpress data | ✓ SATISFIED | Orchestrator supports AliExpress via Apify/Oxylabs |
| SCRAPE-02: Extract Amazon data | ✓ SATISFIED | Orchestrator supports Amazon via Oxylabs/Apify |
| SCRAPE-03: Scraper abstraction layer | ✓ SATISFIED | ScraperProvider interface, pluggable providers |
| SCRAPE-04: Queue-based async scraping | ✓ SATISFIED | Inngest handles async processing with retries |

### Anti-Patterns Found

None detected. All files are substantive implementations with no TODO comments, stub patterns, or placeholder content.

### Human Verification Required

#### 1. End-to-End Import Flow

**Test:** Paste an AliExpress product URL and complete the import flow

**Expected:**
- Immediate redirect to status page
- Status page shows "Scraping..." with polling animation
- After 30-60 seconds, auto-redirect to product page
- Product page shows scraped title, images, price

**Why human:** Requires real browser interaction, external API calls, timing verification

#### 2. AI Vision Fallback Trigger

**Test:** Import a product URL that typically fails text extraction but returns images

**Expected:**
- Job completes successfully
- Product has title and description
- Product metadata shows provider with "+vision" suffix
- Product.aiGenerated flag is true

**Why human:** Requires specific URLs known to trigger fallback, verification of AI-generated content quality

#### 3. Failed Job Retry

**Test:** Import with invalid credentials or timeout, verify error UI

**Expected:**
- Status page shows "Failed" state with error message
- Retry button redirects back to import form
- Can re-submit and job queues again

**Why human:** Requires simulating failure conditions, UI/UX verification

#### 4. Cost Tracking Accuracy

**Test:** After gap closure, import products with different providers and verify cost metadata

**Expected:**
- Apify AliExpress: ~$0.015
- Oxylabs Amazon: ~$0.020
- Hybrid (apify+vision): ~$0.020 ($0.015 + $0.005)

**Why human:** Requires multiple imports across providers, manual cost verification

### Gaps Summary

**Critical Gap:** Cost metadata not persisted to database

The orchestrator correctly generates cost metadata via `createCostMetadata()` and attaches it to the `ScrapedProduct` object as `scraped.costMetadata`. However, the Inngest function (`scrape-product.ts`) only stores a subset of fields in the product metadata:

```typescript
metadata: {
  scrapedAt: ...,
  provider: scraped.provider,
  scrapeDuration: scrapeDuration,
  brand: scraped.brand,
  sku: scraped.sku,
  reviewSummary: scraped.reviewSummary,
  seller: scraped.seller,
  // MISSING: scrapeCost from scraped.costMetadata
}
```

**Impact:** Truth #10 ("Cost stored in product metadata") fails. Without persisted cost data, Phase 5 subscription enforcement cannot sum merchant usage.

**Fix Required:** Add `scrapeCost: scraped.costMetadata` to the metadata object in scrape-product.ts lines 85-94.

**Why This Matters:** The entire cost tracking infrastructure exists and works correctly — the orchestrator generates accurate cost estimates, the schema documents the structure, and the aggregation utilities are ready. The only missing piece is the final storage step. This is a simple one-line addition to close the gap.

---

_Verified: 2026-01-31T22:15:00Z_
_Verifier: Claude (gsd-verifier)_
