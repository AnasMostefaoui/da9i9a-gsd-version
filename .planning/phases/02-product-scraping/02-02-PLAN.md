---
phase: 02-product-scraping
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/ai/vision.server.ts
  - app/services/scraping/orchestrator.server.ts
autonomous: true
gap_closure: true
user_setup:
  - service: gemini
    why: "Vision API for image analysis (same key as text generation)"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Already configured from Phase 1 AI setup"

must_haves:
  truths:
    - "Products with images but no text still get title and description"
    - "AI fallback only triggers when text scraping fails"
    - "Generated content clearly marked as AI-generated in metadata"
  artifacts:
    - path: "app/services/ai/vision.server.ts"
      provides: "Gemini Vision image analysis"
      exports: ["analyzeProductImage", "isVisionConfigured"]
    - path: "app/services/scraping/orchestrator.server.ts"
      provides: "Updated orchestrator with AI fallback"
      contains: "analyzeProductImage"
  key_links:
    - from: "app/services/scraping/orchestrator.server.ts"
      to: "app/services/ai/vision.server.ts"
      via: "Import and conditional call"
      pattern: "analyzeProductImage.*images\\[0\\]"
---

<objective>
Implement AI-from-image fallback when text scraping fails but images are available.

Purpose: Some product pages fail to yield text data (heavy JS, bot detection) but successfully return images. Gemini Vision can analyze the product image and generate a title + description, ensuring the import succeeds even with partial scrape data.

Output: Vision analysis service, updated orchestrator with fallback logic.
</objective>

<execution_context>
@/Users/mostefaouim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mostefaouim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-product-scraping/02-CONTEXT.md

# Existing Gemini implementation
@app/services/ai/gemini.server.ts

# Orchestrator to modify
@app/services/scraping/orchestrator.server.ts
@app/services/scraping/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gemini Vision service</name>
  <files>
    app/services/ai/vision.server.ts
  </files>
  <action>
Create `app/services/ai/vision.server.ts`:

1. Use same Gemini API but with vision capability (gemini-2.5-flash supports vision)
2. Function `analyzeProductImage(imageUrl: string, platform: Platform)`:
   - Download image or pass URL directly to Gemini
   - Prompt Gemini to analyze the product image
   - Return: { title: string, description: string, category?: string }

Prompt design:
```
You are analyzing a product image from {platform} to generate listing content.

Look at this product image and provide:
1. A concise, benefit-focused product title (max 65 characters)
2. A marketing description (2 paragraphs) based on what you see
3. Product category (e.g., "Electronics", "Fashion", "Home & Garden")

Focus on:
- What the product IS (not assumptions about brand/price)
- Visible features and quality indicators
- Use case and benefits

Return JSON: { "title": "...", "description": "...", "category": "..." }
```

3. Export `isVisionConfigured()` - same as `isGeminiConfigured()` since same API key

Implementation notes:
- Gemini 2.5 Flash accepts image URLs directly in the request
- Use `inlineData` with base64 if URL fetch fails
- Add timeout (30 seconds) for image analysis
- Mark generated content source as "ai-vision" in return value
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Function exported: `grep "export.*analyzeProductImage" app/services/ai/vision.server.ts`
  </verify>
  <done>
Vision service can analyze product images and generate title/description.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate fallback into orchestrator</name>
  <files>
    app/services/scraping/orchestrator.server.ts
  </files>
  <action>
Modify `app/services/scraping/orchestrator.server.ts` to add AI fallback:

1. Import vision service: `import { analyzeProductImage, isVisionConfigured } from "~/services/ai/vision.server"`

2. Modify `validateProduct()` method:
   - Current: Throws error if no title
   - New: Track missing fields but don't throw if we have images

3. Add fallback logic after all providers fail OR after successful scrape with missing text:

```typescript
// After scraping completes but before final return
if (product.images.length > 0 && (!product.title || product.title.trim() === "")) {
  if (isVisionConfigured()) {
    console.log("[Orchestrator] Text scraping failed, attempting AI vision fallback...");
    try {
      const visionResult = await analyzeProductImage(product.images[0], platform);
      product.title = visionResult.title;
      product.description = visionResult.description || product.description;
      product.provider = `${product.provider}+vision`;  // Track hybrid source
      console.log(`[Orchestrator] AI vision generated: "${product.title}"`);
    } catch (visionError) {
      console.error("[Orchestrator] AI vision fallback failed:", visionError);
      // Still throw original error - we truly have no title
      throw new Error(`Failed to scrape product text and AI vision fallback failed`);
    }
  }
}
```

4. Update return type to include `aiGenerated?: boolean` flag in metadata

Key behavior:
- Only triggers when: images exist AND (title missing OR providers exhausted)
- Does NOT trigger for: successful scrapes with title
- Marks content source in provider field: "apify+vision" or "oxylabs+vision"
  </action>
  <verify>
Vision import exists: `grep "analyzeProductImage" app/services/scraping/orchestrator.server.ts`
Fallback logic exists: `grep "vision fallback" app/services/scraping/orchestrator.server.ts`
  </verify>
  <done>
Orchestrator uses AI vision when text scraping fails but images exist.
  </done>
</task>

</tasks>

<verification>
1. Test with a product URL that typically fails text extraction
2. Verify AI vision is called when title is missing
3. Check product metadata shows "provider+vision" hybrid source
4. Ensure successful scrapes do NOT trigger vision (check logs)
</verification>

<success_criteria>
- Products with images but no text get AI-generated title/description
- AI fallback clearly logged and tracked in metadata
- Normal scrapes (with text) don't trigger vision API
- Vision errors are caught and logged, not silent failures
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-scraping/02-02-SUMMARY.md`
</output>
