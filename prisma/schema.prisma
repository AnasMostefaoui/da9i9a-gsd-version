generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Salla merchant who installed the app
model Merchant {
  id              String    @id @default(cuid())
  sallaId         Int       @unique @map("salla_id")
  storeName       String    @map("store_name")
  storeUrl        String    @map("store_url")
  email           String?
  accessToken     String    @map("access_token")
  refreshToken    String    @map("refresh_token")
  tokenExpiresAt  DateTime  @map("token_expires_at")
  plan            String?
  status          MerchantStatus @default(ACTIVE)
  dataRetention   DataRetention  @default(DELETE_AFTER_30_DAYS) @map("data_retention")
  uninstalledAt   DateTime?      @map("uninstalled_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  products        Product[]

  @@map("merchants")
}

enum MerchantStatus {
  ACTIVE
  UNINSTALLED
  EXPIRED
}

enum DataRetention {
  DELETE_AFTER_30_DAYS
  KEEP_FOREVER
}

// Imported product
model Product {
  id              String    @id @default(cuid())
  merchantId      String    @map("merchant_id")
  merchant        Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  // Source info
  sourceUrl       String    @map("source_url")
  platform        Platform

  // Product data
  titleAr         String?   @map("title_ar")
  titleEn         String?   @map("title_en")
  descriptionAr   String?   @map("description_ar") @db.Text
  descriptionEn   String?   @map("description_en") @db.Text
  price           Decimal   @db.Decimal(10, 2)
  currency        String    @default("SAR")

  // Images (stored as JSON array of URLs)
  images          String[]  @default([])
  selectedImages  Int[]     @default([]) @map("selected_images")
  enhancedImages  String[]  @default([]) @map("enhanced_images")

  // Status
  status          ProductStatus @default(IMPORTED)
  sallaProductId  Int?      @map("salla_product_id")
  pushedAt        DateTime? @map("pushed_at")

  // Additional metadata (scraping info, brand, SKU, cost tracking, etc.)
  // Expected structure:
  // {
  //   scrapedAt: string,           // ISO timestamp when scraped
  //   provider: string,            // Scraping provider used (e.g., "apify", "oxylabs")
  //   scrapeDuration: number,      // Scrape duration in milliseconds
  //   brand?: string,
  //   sku?: string,
  //   reviewSummary?: { rating: number, count: number },
  //   seller?: { name: string, rating?: number },
  //   scrapeCost?: {
  //     provider: string,          // Provider that performed the scrape
  //     platform: string,          // Target platform (aliexpress, amazon)
  //     estimatedCostUsd: number,  // Estimated cost in USD
  //     scrapedAt: string,         // ISO timestamp
  //     duration: number           // Duration in milliseconds
  //   },
  //   aiProvider?: string,         // AI provider used for enhancement
  //   aiGeneratedAt?: string,      // When AI content was generated
  //   highlights?: string[],       // AI-generated highlights (English)
  //   highlightsAr?: string[]      // AI-generated highlights (Arabic)
  // }
  metadata        Json?     @default("{}")

  // Landing page content (AI-generated JSON for template rendering)
  landingPageContent  Json?     @map("landing_page_content")
  contentLang         String    @default("ar") @map("content_lang")
  colorPalette        String    @default("orange") @map("color_palette")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("products")
}

enum Platform {
  ALIEXPRESS
  AMAZON
}

enum ProductStatus {
  IMPORTING    // Scraping in progress
  IMPORTED     // Scraped, ready for editing
  ENHANCED     // AI enhancement complete
  PUSHING      // Push to Salla in progress
  PUSHED       // Live on Salla
  FAILED       // Something went wrong
}

// Webhook event history for debugging and audit
model WebhookHistory {
  id              String    @id @default(cuid())
  merchantSallaId Int       @map("merchant_salla_id")
  event           String
  payload         Json
  status          WebhookStatus @default(RECEIVED)
  processedAt     DateTime?     @map("processed_at")
  error           String?
  receivedAt      DateTime  @default(now()) @map("received_at")

  @@index([merchantSallaId])
  @@index([event])
  @@index([receivedAt])
  @@map("webhook_history")
}

enum WebhookStatus {
  RECEIVED    // Received but not yet processed
  PROCESSING  // Currently being processed by Inngest
  PROCESSED   // Successfully processed
  FAILED      // Processing failed
}
